<div class="flex h-screen bg-white">
  <!-- Sidebar -->
  <app-sidebar></app-sidebar>

  <!-- Main Content -->
  <main class="relative flex-1 flex flex-col overflow-hidden bg-white">
    <!-- Header -->
    <app-pos-header></app-pos-header>

    <!-- Titre de la page -->
    <div class="px-6 pt-4 pb-3 bg-white">
      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
        <div>
          <h1 class="text-xl font-bold text-gray-900 flex items-center gap-2">
            Rapports Financiers
          </h1>
          <p class="text-sm text-gray-500 mt-1">Dashboard > Rapports</p>
        </div>
        <!-- Export Buttons -->
        <div class="flex items-center gap-2">
          @if (authService.canRead('reports')) {
          <button
            (click)="exportToPDF()"
            [disabled]="loading() || selectionMode()"
            class="px-4 py-2.5 bg-amber-400 text-white text-sm font-medium rounded-lg hover:bg-amber-600 transition-colors disabled:opacity-50 flex items-center gap-2 cursor-pointer disabled:cursor-not-allowed">
            <ng-icon name="hugePdf01" size="18" />
            <span class="hidden sm:inline">Export PDF</span>
          </button>
          }
          @if (authService.canRead('reports')) {
          <button
            (click)="exportToExcel()"
            [disabled]="loading() || selectionMode()"
            class="px-4 py-2.5 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 flex items-center gap-2 cursor-pointer disabled:cursor-not-allowed">
            <ng-icon name="hugeXls01" size="18" />
            <span class="hidden sm:inline">Export Excel</span>
          </button>
          }
          @if (authService.canRead('reports')) {
          <button
            (click)="openComparisonModal()"
            [disabled]="loading() || selectionMode()"
            class="px-4 py-2.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 flex items-center gap-2 cursor-pointer disabled:cursor-not-allowed">
            <ng-icon name="hugeGitCompare" size="18" />
            <span class="hidden sm:inline">Comparer Profit par Dates</span>
          </button>
          }
        </div>
      </div>
    </div>

    <!-- Success Message -->
    @if (successMessage()) {
      <div class="mx-6 mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-center gap-3">
        <ng-icon name="hugeCheckmarkCircle04" size="20" class="text-green-600"></ng-icon>
        <span class="text-green-700">{{ successMessage() }}</span>
      </div>
    }

    <!-- Error Message -->
    @if (errorMessage()) {
      <div class="mx-6 mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-center gap-3">
        <ng-icon name="hugeAlert01" size="20" class="text-red-600"></ng-icon>
        <span class="text-red-700 text-sm">{{ errorMessage() }}</span>
      </div>
    }

    <!-- Selection Mode Info -->
    @if (selectionMode()) {
      <div class="mx-6 mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-between">
        <div class="flex items-center gap-3">
          <ng-icon name="hugeAlert01" size="20" class="text-blue-600"></ng-icon>
          <span class="text-blue-700 text-sm">
            Mode s√©lection activ√©. Cliquez sur les ventes √† supprimer.
            <span class="font-semibold">{{ selectedSaleIds().size }} s√©lectionn√©(s)</span>
          </span>
        </div>
      </div>
    }

    <!-- Bouton flottant Toggle Stats -->
    <button
      (click)="showStats.set(!showStats())"
      class="fixed -right-2 z-50 p-3 bg-blue-600/70 text-white rounded-l-full shadow-lg hover:bg-blue-700 transition-all hover:scale-110 cursor-pointer"
      [style.top]="showStats() ? '175px' : '45px'"
      [title]="showStats() ? 'Masquer les statistiques' : 'Afficher les statistiques'">
      <ng-icon [name]="showStats() ? 'hugeViewOff' : 'hugeEye'" size="20" strokeWidth="2"></ng-icon>
    </button>

    <!-- Statistiques -->
    @if (showStats()) {
      <div class="px-6 pb-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
          <!-- Revenu Total -->
          <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl border border-green-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-green-600 font-medium">Revenu Total</p>
                <p class="text-2xl font-bold text-green-900 mt-1" [innerHTML]="stats().totalRevenue | gdesCurrency"></p>
              </div>
              <div class="p-3 bg-green-500 rounded-lg text-white">
                <ng-icon name="hugeMoneyBag02" size="24" class="text-white"></ng-icon>
              </div>
            </div>
          </div>

          <!-- Profit Total -->
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border border-blue-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-blue-600 font-medium">Profit Total</p>
                <p class="text-2xl font-bold text-blue-900 mt-1" [innerHTML]="stats().totalProfit | gdesCurrency"></p>
              </div>
              <div class="p-3 bg-blue-500 rounded-lg text-white">
                <ng-icon name="hugeChartColumn" size="24" class="text-white"></ng-icon>
              </div>
            </div>
          </div>

          <!-- Nombre de Ventes -->
          <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border border-purple-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-purple-600 font-medium">Nombre de Ventes</p>
                <p class="text-2xl font-bold text-purple-900 mt-1">{{ stats().totalSales }}</p>
              </div>
              <div class="p-3 bg-purple-500 rounded-lg text-white">
                <ng-icon name="hugeSafeDelivery01" size="24" class="text-white"></ng-icon>
              </div>
            </div>
          </div>

          <!-- Panier Moyen -->
          <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-xl border border-orange-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-orange-600 font-medium">Panier Moyen</p>
                <p class="text-2xl font-bold text-orange-900 mt-1" [innerHTML]="stats().averageSaleValue | gdesCurrency"></p>
              </div>
              <div class="p-3 bg-orange-500 rounded-lg text-white">
                <ng-icon name="hugeChartMedium" size="24" class="text-white"></ng-icon>
              </div>
            </div>
          </div>

          <!-- Marge B√©n√©ficiaire -->
          <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 p-4 rounded-xl border border-indigo-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-indigo-600 font-medium">Marge B√©n√©ficiaire</p>
                <p class="text-2xl font-bold text-indigo-900 mt-1">{{ formatPercent(stats().profitMargin) }}</p>
              </div>
              <div class="p-3 bg-indigo-500 rounded-lg text-white">
                <ng-icon name="hugeChartHistogram" size="24" class="text-white"></ng-icon>
              </div>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Comparison Modal -->
    @if (showComparisonModal()) {
      <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <!-- Modal Header -->
          <div class="bg-blue-600 p-6 border-b border-gray-200 flex items-center justify-between">
            <h2 class="text-xl font-bold text-white">Comparaison de Dates</h2>
            <button
              (click)="closeComparisonModal()"
              class="text-white hover:text-gray-400 transition-colors">
              <span class="text-4xl font-light">&times;</span>
            </button>
          </div>

          <!-- Modal Body -->
          <div class="p-6">
            <!-- Date Selectors and Compare Button on same line -->
            <div class="flex flex-wrap items-end gap-4 mb-6">
              <div class="flex-1 min-w-[200px]">
                <label class="block text-sm font-medium text-gray-700 mb-2">Premi√®re Date</label>
                <input
                  type="date"
                  [(ngModel)]="comparisonDate1"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
              </div>
              <div class="flex-1 min-w-[200px]">
                <label class="block text-sm font-medium text-gray-700 mb-2">Deuxi√®me Date</label>
                <input
                  type="date"
                  [(ngModel)]="comparisonDate2"
                  [min]="comparisonDate1"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
              </div>
              <button
                (click)="compareData()"
                [disabled]="!comparisonDate1 || !comparisonDate2 || loading()"
                class="flex items-center justify-center px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap">
                <ng-icon name="hugeGitCompare" size="18" class="mr-2"></ng-icon>
                Comparer
              </button>
            </div>

            <!-- Messages Section -->
            @if (loading()) {
              <div class="mb-4 p-3 bg-blue-100 border border-blue-400 text-blue-700 rounded-lg flex items-center">
                <svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Chargement des donn√©es de comparaison...</span>
              </div>
            }

            @if (errorMessage()) {
              <div class="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg flex items-start">
                <svg class="h-5 w-5 mr-3 mt-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>{{ errorMessage() }}</span>
              </div>
            }

            @if (successMessage()) {
              <div class="mb-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded-lg flex items-center">
                <svg class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <span>{{ successMessage() }}</span>
              </div>
            }

            <!-- Comparison Results -->
            @if (comparisonResults(); as results) {
              <div class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">R√©sultats de la Comparaison</h3>

                <!-- Comparison Table will be inserted here -->
                <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-300">
                      <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-900 uppercase tracking-wider">M√©trique</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-900 uppercase tracking-wider">{{ comparisonDate1 }}</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-900 uppercase tracking-wider">{{ comparisonDate2 }}</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-900 uppercase tracking-wider">√âvolution</th>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                      <!-- Revenue Row -->
                      <tr class="table-row-hover">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Revenu Total</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900" [innerHTML]="results.revenue.value1 | gdesCurrency"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900" [innerHTML]="results.revenue.value2 | gdesCurrency"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                          <div class="flex items-center justify-center gap-2">
                            @if (results.revenue.diff > 0) {
                              <ng-icon name="hugeArrowUp02" size="18" class="text-green-600" />
                              <span class="text-green-600 font-semibold">+{{ results.revenue.percentChange.toFixed(2) }}%</span>
                            } @else if (results.revenue.diff < 0) {
                              <ng-icon name="hugeArrowDown02" size="18" class="text-red-600" />
                              <span class="text-red-600 font-semibold">{{ results.revenue.percentChange.toFixed(2) }}%</span>
                            } @else {
                              <span class="text-gray-600">0%</span>
                            }
                          </div>
                        </td>
                      </tr>

                      <!-- Profit Row -->
                      <tr class="table-row-hover">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Profit Total</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900" [innerHTML]="results.profit.value1 | gdesCurrency"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900" [innerHTML]="results.profit.value2 | gdesCurrency"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                          <div class="flex items-center justify-center gap-2">
                            @if (results.profit.diff > 0) {
                              <ng-icon name="hugeArrowUp02" size="18" class="text-green-600" />
                              <span class="text-green-600 font-semibold">+{{ results.profit.percentChange.toFixed(2) }}%</span>
                            } @else if (results.profit.diff < 0) {
                              <ng-icon name="hugeArrowDown02" size="18" class="text-red-600" />
                              <span class="text-red-600 font-semibold">{{ results.profit.percentChange.toFixed(2) }}%</span>
                            } @else {
                              <span class="text-gray-600">0%</span>
                            }
                          </div>
                        </td>
                      </tr>

                      <!-- Sales Row -->
                      <tr class="table-row-hover">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Nombre de Ventes</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">{{ results.sales.value1 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">{{ results.sales.value2 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                          <div class="flex items-center justify-center gap-2">
                            @if (results.sales.diff > 0) {
                              <ng-icon name="hugeArrowUp02" size="18" class="text-green-600" />
                              <span class="text-green-600 font-semibold">+{{ results.sales.percentChange.toFixed(2) }}%</span>
                            } @else if (results.sales.diff < 0) {
                              <ng-icon name="hugeArrowDown02" size="18" class="text-red-600" />
                              <span class="text-red-600 font-semibold">{{ results.sales.percentChange.toFixed(2) }}%</span>
                            } @else {
                              <span class="text-gray-600">0%</span>
                            }
                          </div>
                        </td>
                      </tr>

                      <!-- Products Sold Row -->
                      <tr class="table-row-hover">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Nombre de Produits Vendus</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">{{ results.productsSold.value1 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">{{ results.productsSold.value2 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                          <div class="flex items-center justify-center gap-2">
                            @if (results.productsSold.diff > 0) {
                              <ng-icon name="hugeArrowUp02" size="18" class="text-green-600" />
                              <span class="text-green-600 font-semibold">+{{ results.productsSold.percentChange.toFixed(2) }}%</span>
                            } @else if (results.productsSold.diff < 0) {
                              <ng-icon name="hugeArrowDown02" size="18" class="text-red-600" />
                              <span class="text-red-600 font-semibold">{{ results.productsSold.percentChange.toFixed(2) }}%</span>
                            } @else {
                              <span class="text-gray-600">0%</span>
                            }
                          </div>
                        </td>
                      </tr>

                      <!-- Average Sale Row -->
                      <tr class="table-row-hover">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Panier Moyen</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900" [innerHTML]="results.averageSale.value1 | gdesCurrency"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900" [innerHTML]="results.averageSale.value2 | gdesCurrency"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                          <div class="flex items-center justify-center gap-2">
                            @if (results.averageSale.diff > 0) {
                              <ng-icon name="hugeArrowUp02" size="18" class="text-green-600" />
                              <span class="text-green-600 font-semibold">+{{ results.averageSale.percentChange.toFixed(2) }}%</span>
                            } @else if (results.averageSale.diff < 0) {
                              <ng-icon name="hugeArrowDown02" size="18" class="text-red-600" />
                              <span class="text-red-600 font-semibold">{{ results.averageSale.percentChange.toFixed(2) }}%</span>
                            } @else {
                              <span class="text-gray-600">0%</span>
                            }
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            }
          </div>

          <!-- Modal Footer -->
          <div class="p-6 border-t border-gray-200 flex justify-end">
            <button
              (click)="closeComparisonModal()"
              class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors">
              Fermer
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Contenu principal -->
    <div class="flex-1 overflow-y-auto px-6 pb-6 bg-white">
      <div class="bg-gray-100 rounded-[15px] p-4 border border-gray-300">

        <!-- Loading State -->
        @if (loading()) {
          <div class="flex items-center justify-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-teal-500 border-t-transparent"></div>
          </div>
        }

        <!-- Tableau des ventes -->
        @else {
          <div class="bg-white rounded-lg border border-gray-200 overflow-x-auto mb-15">
            <div class="p-4 border-b border-gray-200 bg-gray-50">
              <!-- Titre, Filtres de p√©riode, dates et Total sur la m√™me ligne -->
              <div class="flex flex-wrap items-center gap-3 mb-4">
                <div>
                  <h3 class="text-base font-semibold text-gray-900">Toutes les Ventes</h3>
                  <p class="text-xs text-gray-500 mt-1">{{ allSales().length }} vente(s) trouv√©e(s)</p>
                </div>

                <!-- S√©parateur vertical -->
                <div class="hidden lg:block h-10 w-px bg-gray-300"></div>

                <!-- Filtres rapides de p√©riode -->
                <button
                  (click)="setQuickRange('daily')"
                  [class]="'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ' + (reportType() === 'daily' ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')">
                  Aujourd'hui
                </button>
                <button
                  (click)="setQuickRange('weekly')"
                  [class]="'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ' + (reportType() === 'weekly' ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')">
                  Semaine
                </button>
                <button
                  (click)="setQuickRange('monthly')"
                  [class]="'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ' + (reportType() === 'monthly' ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')">
                  Mois
                </button>
                <button
                  (click)="setQuickRange('yearly')"
                  [class]="'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ' + (reportType() === 'yearly' ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')">
                  Ann√©e
                </button>

                <!-- S√©parateur vertical -->
                <div class="hidden lg:block h-10 w-px bg-gray-300"></div>

                <!-- Custom Date Range -->
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-500">De</span>
                  <input
                    type="date"
                    [(ngModel)]="startDate"
                    (change)="onDateRangeChange()"
                    class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <span class="text-xs text-gray-500">√†</span>
                  <input
                    type="date"
                    [(ngModel)]="endDate"
                    [min]="startDate"
                    (change)="onDateRangeChange()"
                    class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <!-- S√©parateur vertical -->
                <div class="hidden lg:block h-10 w-px bg-gray-300"></div>

                <!-- Total -->
                <div class="text-right ml-auto">
                  <p class="text-xs text-gray-500">Total</p>
                  <p class="text-sm font-semibold text-gray-900" [innerHTML]="stats().totalRevenue | gdesCurrency"></p>
                </div>
              </div>

              <!-- Filtre par vendeur et pagination -->
              <div class="flex flex-wrap items-center gap-3">
                <div class="flex items-center gap-3">
                  <span class="text-sm font-medium text-gray-700">Recherche par Vendeur :</span>
                  <select
                    [(ngModel)]="selectedSellerId"
                    (change)="loadReports()"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                    <option value="all">Tous les vendeurs</option>
                    @for (seller of sellers(); track seller.id) {
                      <option [value]="seller.id">{{ seller.fullName || seller.username }}</option>
                    }
                  </select>
                </div>

                <!-- Items per page selector -->
                <div class="ml-auto flex items-center gap-3">
                  <select
                    (change)="onItemsPerPageChange($event)"
                    [value]="itemsPerPage()"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-teal-500 focus:border-transparent bg-white cursor-pointer">
                    <option value="10">üìÑ 10 par page</option>
                    <option value="20">üìÑ 20 par page</option>
                    <option value="30">üìÑ 30 par page</option>
                    <option value="40">üìÑ 40 par page</option>
                    <option value="50">üìÑ 50 par page</option>
                  </select>

                  <!-- Selection button -->
                  @if (authService.canDelete('reports')) {
                  <button
                    (click)="toggleSelectionMode()"
                    [disabled]="loading() || allSales().length === 0"
                    [class]="(selectionMode() && selectedSaleIds().size > 0)
                      ? 'px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2 cursor-pointer shadow-md disabled:opacity-50 disabled:cursor-not-allowed'
                      : 'px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-lg hover:bg-gray-700 transition-colors flex items-center gap-2 cursor-pointer shadow-md disabled:opacity-50 disabled:cursor-not-allowed'">
                    <ng-icon name="hugeDelete03" size="18" />
                    @if (selectionMode()) {
                      @if (selectedSaleIds().size > 0) {
                        <span>Supprimer ({{ selectedSaleIds().size }})</span>
                      } @else {
                        <span>Annuler</span>
                      }
                    } @else {
                      <span>S√©lectionner</span>
                    }
                  </button>
                  }
                </div>
              </div>
            </div>
            <div class="table-container-fixed">
              <table class="min-w-full divide-y divide-gray-200 table-fixed">
                <thead class="bg-teal-600 text-white sticky top-0 z-10">
                  <tr>
                    @if (selectionMode()) {
                      <th class="w-12 px-3 py-4 text-center">
                        <input
                          type="checkbox"
                          [checked]="allSalesSelected()"
                          (change)="toggleSelectAll()"
                          class="w-4 h-4 text-teal-600 bg-gray-100 border-gray-300 rounded focus:ring-teal-500 cursor-pointer"
                          title="S√©lectionner tout">
                      </th>
                    }
                    <th class="w-12 px-3 py-4"></th>
                    <th class="px-3 md:px-6 py-4 text-left text-xs font-medium uppercase tracking-wider whitespace-nowrap">Date</th>
                    <th class="px-3 md:px-6 py-4 text-left text-xs font-medium uppercase tracking-wider whitespace-nowrap">Vendeur</th>
                    <th class="px-3 md:px-6 py-4 text-left text-xs font-medium uppercase tracking-wider whitespace-nowrap">Nbs de Produits</th>
                    <th class="px-3 md:px-6 py-4 text-left text-xs font-medium uppercase tracking-wider whitespace-nowrap">Mode Paiement</th>
                    <th class="px-3 md:px-6 py-4 text-right text-xs font-medium uppercase tracking-wider whitespace-nowrap">Montant</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  @if (allSales().length === 0) {
                    <tr>
                      <td [attr.colspan]="selectionMode() ? 7 : 6" class="px-6 py-8 text-center text-gray-500">
                        Aucune vente trouv√©e pour cette p√©riode
                      </td>
                    </tr>
                  }
                  @for (sale of paginatedSales(); track sale.id) {
                    <!-- Main sale row -->
                    <tr [class]="'transition-colors ' + (isSaleSelected(sale.id) ? 'bg-red-100 border-l-4 border-l-red-600' : 'hover:bg-gray-50 odd:bg-white even:bg-gray-50')" [style.cursor]="selectionMode() ? 'pointer' : 'default'" (click)="selectionMode() ? toggleSaleSelection(sale.id) : toggleSaleDetails(sale.id)">
                      @if (selectionMode()) {
                        <td class="px-3 py-4 whitespace-nowrap text-center" (click)="$event.stopPropagation()">
                          <input
                            type="checkbox"
                            [checked]="isSaleSelected(sale.id)"
                            (change)="toggleSaleSelection(sale.id)"
                            [class]="isSaleSelected(sale.id) ? 'w-4 h-4 text-red-600 bg-gray-100 border-red-500 rounded focus:ring-red-500 cursor-pointer accent-red-600' : 'w-4 h-4 text-teal-600 bg-gray-100 border-gray-300 rounded focus:ring-teal-500 cursor-pointer'">
                        </td>
                      }
                      <td class="px-3 py-4 whitespace-nowrap text-center" (click)="$event.stopPropagation(); toggleSaleDetails(sale.id)">
                        <button class="text-gray-500 hover:text-gray-700 focus:outline-none">
                          @if (expandedSaleId() === sale.id) {
                            <ng-icon name="hugeArrowDownDouble" size="18" />
                          } @else {
                            <ng-icon name="hugeArrowRightDouble" size="18" />
                          }
                        </button>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {{ sale.createdAt | date:'dd/MM/yyyy hh:mm a' }}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {{ sale.seller?.fullName || sale.seller?.username || 'Inconnu' }}
                      </td>
                      <td class="px-6 py-4 text-sm text-gray-500">
                        {{ sale.items.length || 0 }} produit(s)
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span [class]="'px-2 py-1 text-xs rounded-full ' +
                          (sale.paymentMethod === 'cash' ? 'bg-green-100 text-green-800' :
                          sale.paymentMethod === 'card' ? 'bg-blue-100 text-blue-800' :
                          sale.paymentMethod === 'mobile_money' ? 'bg-purple-100 text-purple-800' :
                          sale.paymentMethod === 'bank_transfer' ? 'bg-amber-100 text-amber-800' :
                          'bg-gray-100 text-gray-800')">
                          {{ sale.paymentMethod === 'cash' ? 'Esp√®ces' :
                            sale.paymentMethod === 'card' ? 'Carte' :
                            sale.paymentMethod === 'mobile_money' ? 'Mobile Money' :
                            sale.paymentMethod === 'bank_transfer' ? 'Virement' :
                            sale.paymentMethod }}
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-semibold text-gray-900" [innerHTML]="sale.total | gdesCurrency">
                      </td>
                    </tr>

                    <!-- Expanded details row -->
                    @if (expandedSaleId() === sale.id) {
                      <tr>
                        <td [attr.colspan]="selectionMode() ? 7 : 6" class="px-0 py-0 bg-gray-50">
                          <div class="px-6 py-4">
                            <table class="min-w-full bg-white border border-gray-200 overflow-hidden">
                              <thead class="bg-teal-300">
                                <tr>
                                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Nom Produit</th>
                                  <th class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Prix</th>
                                  <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">Quantit√©</th>
                                  <th class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Total</th>
                                </tr>
                              </thead>
                              <tbody class="divide-y divide-gray-200">
                                @for (item of sale.items; track $index) {
                                  <tr class="table-row-hover">
                                    <td class="px-4 py-3 text-sm text-gray-900">{{ item.productName }}</td>
                                    <td class="px-4 py-3 text-sm text-right text-gray-900" [innerHTML]="item.unitPrice | gdesCurrency"></td>
                                    <td class="px-4 py-3 text-sm text-center text-gray-900">{{ item.quantity }}</td>
                                    <td class="px-4 py-3 text-sm text-right font-semibold text-gray-900" [innerHTML]="item.subtotal | gdesCurrency"></td>
                                  </tr>
                                }
                              </tbody>
                            </table>
                          </div>
                        </td>
                      </tr>
                    }
                  }
                </tbody>
              </table>
            </div>

            <!-- Pagination Controls -->
            <div class="mt-0 flex flex-col sm:flex-row items-center justify-between gap-4 bg-gray-200 px-4 py-3 rounded-b-lg">
              <!-- Info Section -->
              <div class="text-sm text-gray-900">
                Affichage des r√©sultats {{ paginationInfo().startIndex }} √† {{ paginationInfo().endIndex }} sur {{ paginationInfo().total }}
              </div>

              <!-- Navigation Buttons -->
              <div class="flex items-center gap-1">
                <!-- First Page Button -->
                <button
                  (click)="firstPage()"
                  [disabled]="paginationInfo().currentPage === 1"
                  class="px-3 py-1.5 text-sm text-gray-900 hover:bg-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer transition-colors">
                  ¬´
                </button>

                <!-- Previous Button -->
                <button
                  (click)="previousPage()"
                  [disabled]="paginationInfo().currentPage === 1"
                  class="px-3 py-1.5 text-sm text-gray-900 hover:bg-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer transition-colors">
                  ‚Äπ
                </button>

                <!-- Page Numbers -->
                @for (page of getPageNumbers(); track page) {
                  <button
                    (click)="goToPage(page)"
                    [class]="page === paginationInfo().currentPage
                      ? 'px-3 py-1.5 text-sm bg-gray-700 text-white rounded cursor-pointer'
                      : 'px-3 py-1.5 text-sm text-gray-300 hover:bg-gray-700 rounded cursor-pointer transition-colors'">
                    {{ page }}
                  </button>
                }

                <!-- Next Button -->
                <button
                  (click)="nextPage()"
                  [disabled]="paginationInfo().currentPage === paginationInfo().totalPages"
                  class="px-3 py-1.5 text-sm text-gray-900 hover:bg-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer transition-colors">
                  ‚Ä∫
                </button>

                <!-- Last Page Button -->
                <button
                  (click)="lastPage()"
                  [disabled]="paginationInfo().currentPage === paginationInfo().totalPages"
                  class="px-3 py-1.5 text-sm text-gray-900 hover:bg-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer transition-colors">
                  ¬ª
                </button>
              </div>

              <!-- Summary Info -->
              <div class="text-sm text-gray-900 flex items-center gap-1">
                <span>Total ventes : </span>
                <strong class="text-teal-600 text-base">{{ paginationInfo().total }}</strong>
              </div>
            </div>
          </div>

          <!-- Tableau Top 10 Produits D√©taill√© -->
          <div class="bg-white rounded-lg border border-gray-200 overflow-x-auto mb-15">
            <div class="p-4 border-b border-gray-200 bg-gray-50 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
              <div>
                <h3 class="text-base font-semibold text-gray-900">Top 5 Produits les Plus Vendus</h3>
                <p class="text-xs text-gray-500 mt-1">Classement par quantit√© vendue</p>
              </div>
              <div class="flex items-center gap-2 flex-wrap">
                <button
                  (click)="onTopProductsPeriodChange('daily')"
                  [class]="'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ' + (topProductsPeriod() === 'daily' ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')">
                  Aujourd'hui
                </button>
                <button
                  (click)="onTopProductsPeriodChange('weekly')"
                  [class]="'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ' + (topProductsPeriod() === 'weekly' ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')">
                  Semaine
                </button>
                <button
                  (click)="onTopProductsPeriodChange('monthly')"
                  [class]="'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ' + (topProductsPeriod() === 'monthly' ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')">
                  Mois
                </button>
                <button
                  (click)="onTopProductsPeriodChange('yearly')"
                  [class]="'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ' + (topProductsPeriod() === 'yearly' ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')">
                  Ann√©e
                </button>
              </div>
            </div>
            <table class="min-w-full divide-y divide-gray-200 table-fixed">
              <thead class="bg-teal-600 text-white sticky top-0 z-10">
                <tr>
                  <th class="px-3 md:px-6 py-4 text-center text-xs font-medium uppercase tracking-wider whitespace-nowrap w-16">#</th>
                  <th class="px-3 md:px-6 py-4 text-left text-xs font-medium uppercase tracking-wider whitespace-nowrap">Produit</th>
                  <th class="px-3 md:px-6 py-4 text-center text-xs font-medium uppercase tracking-wider whitespace-nowrap">Quantit√© Vendue</th>
                  <th class="px-3 md:px-6 py-4 text-center text-xs font-medium uppercase tracking-wider whitespace-nowrap">Nb de Ventes</th>
                  <th class="px-3 md:px-6 py-4 text-right text-xs font-medium uppercase tracking-wider whitespace-nowrap">Revenu Total</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                @if (topProductsDetailed().length === 0) {
                  <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                      Aucune donn√©e disponible pour cette p√©riode
                    </td>
                  </tr>
                }
                @for (product of topProductsDetailed(); track product.productId; let i = $index) {
                  <tr class="table-row-hover">
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                      <div class="inline-flex items-center justify-center w-8 h-8 rounded-full text-xs font-bold"
                          [class]="i < 3 ? 'bg-gradient-to-br from-yellow-400 to-orange-500 text-white' : 'bg-gray-100 text-gray-600'">
                        {{ i + 1 }}
                      </div>
                    </td>
                    <td class="px-6 py-4 text-sm">
                      <div class="font-medium text-gray-900">{{ product.productName }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                      <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm font-semibold rounded-full">
                        {{ product.totalQuantity }}
                      </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                      {{ product.salesCount }} vente(s)
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-semibold text-gray-900" [innerHTML]="product.totalRevenue | gdesCurrency">
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Tableau Top Vendeurs D√©taill√© -->
          <div class="bg-white rounded-lg border border-gray-200 overflow-x-auto mb-15">
            <div class="p-4 border-b border-gray-200 bg-gray-50 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
              <div>
                <h3 class="text-base font-semibold text-gray-900">Top Vendeurs</h3>
                <p class="text-xs text-gray-500 mt-1">Classement par chiffre d'affaires</p>
              </div>
              <div class="flex items-center gap-2 flex-wrap">
                <button
                  (click)="onTopSellersPeriodChange('daily')"
                  [class]="'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ' + (topSellersPeriod() === 'daily' ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')">
                  Aujourd'hui
                </button>
                <button
                  (click)="onTopSellersPeriodChange('weekly')"
                  [class]="'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ' + (topSellersPeriod() === 'weekly' ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')">
                  Semaine
                </button>
                <button
                  (click)="onTopSellersPeriodChange('monthly')"
                  [class]="'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ' + (topSellersPeriod() === 'monthly' ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')">
                  Mois
                </button>
                <button
                  (click)="onTopSellersPeriodChange('yearly')"
                  [class]="'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ' + (topSellersPeriod() === 'yearly' ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')">
                  Ann√©e
                </button>
              </div>
            </div>
            <table class="min-w-full divide-y divide-gray-200 table-fixed">
              <thead class="bg-teal-600 text-white sticky top-0 z-10">
                <tr>
                  <th class="px-3 md:px-6 py-4 text-center text-xs font-medium uppercase tracking-wider whitespace-nowrap w-16">#</th>
                  <th class="px-3 md:px-6 py-4 text-left text-xs font-medium uppercase tracking-wider whitespace-nowrap">Vendeur</th>
                  <th class="px-3 md:px-6 py-4 text-center text-xs font-medium uppercase tracking-wider whitespace-nowrap">Nb de Ventes</th>
                  <th class="px-3 md:px-6 py-4 text-right text-xs font-medium uppercase tracking-wider whitespace-nowrap">Chiffre d'Affaires</th>
                  <th class="px-3 md:px-6 py-4 text-right text-xs font-medium uppercase tracking-wider whitespace-nowrap">% du Total</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                @if (topSellersDetailed().length === 0) {
                  <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                      Aucune donn√©e disponible pour cette p√©riode
                    </td>
                  </tr>
                }
                @for (seller of topSellersDetailed(); track seller.sellerId; let i = $index) {
                  <tr class="table-row-hover">
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                      <div class="inline-flex items-center justify-center w-8 h-8 rounded-full text-xs font-bold"
                          [class]="i < 3 ? 'bg-gradient-to-br from-purple-500 to-pink-500 text-white' : 'bg-gray-100 text-gray-600'">
                        {{ i + 1 }}
                      </div>
                    </td>
                    <td class="px-6 py-4">
                      <div class="flex items-center gap-3">
                        <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                          <span class="text-white font-semibold text-sm">{{ getInitials(seller.sellerName) }}</span>
                        </div>
                        <div class="font-medium text-gray-900">{{ seller.sellerName || 'Inconnu' }}</div>
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                      <span class="px-3 py-1 bg-purple-100 text-purple-800 text-sm font-semibold rounded-full">
                        {{ seller.totalSales }}
                      </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-semibold text-gray-900" [innerHTML]="seller.totalRevenue | gdesCurrency">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-semibold text-green-600">
                      {{ formatPercent((seller.totalRevenue / stats().totalRevenue) * 100) }}
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Detailed Report Table -->
          @if (salesReport()) {
            <div [class]="showStats() ? 'table-container-fixed' : 'table-container-fixed-expanded'">
              <div class="p-4 border-b border-gray-200 bg-blue-300 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-30">
                <h3 class="text-base font-semibold text-gray-900">D√©tails du Rapport de Ventes</h3>
              </div>
              <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <!-- Sales Info -->
                  <div class="space-y-3">
                    <h4 class="font-semibold text-gray-700 mb-3">Informations sur les Ventes</h4>
                    <div class="flex justify-between py-2 border-b border-gray-100">
                      <span class="text-gray-600">Nombre total de ventes:</span>
                      <span class="font-semibold text-gray-900">{{ salesReport().totalSales }}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100">
                      <span class="text-gray-600">Revenu total:</span>
                      <span class="font-semibold text-gray-900" [innerHTML]="salesReport().totalRevenue | gdesCurrency"></span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100">
                      <span class="text-gray-600">Valeur moyenne par vente:</span>
                      <span class="font-semibold text-gray-900" [innerHTML]="stats().averageSaleValue | gdesCurrency"></span>
                    </div>
                  </div>

                  <!-- Profit Info -->
                  <div class="space-y-3">
                    <h4 class="font-semibold text-gray-700 mb-3">Informations sur les Profits</h4>
                    <div class="flex justify-between py-2 border-b border-gray-100">
                      <span class="text-gray-600">Co√ªt total:</span>
                      <span class="font-semibold text-gray-900" [innerHTML]="(salesReport().totalCost || 0) | gdesCurrency"></span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100">
                      <span class="text-gray-600">Profit brut:</span>
                      <span class="font-semibold text-blue-600" [innerHTML]="(salesReport().grossProfit || 0) | gdesCurrency"></span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100">
                      <span class="text-gray-600">Marge b√©n√©ficiaire:</span>
                      <span class="font-semibold text-indigo-600">{{ formatPercent(stats().profitMargin) }}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100">
                      <span class="text-gray-600">Remises totales:</span>
                      <span class="font-semibold text-gray-900" [innerHTML]="(salesReport().totalDiscount || 0) | gdesCurrency"></span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100">
                      <span class="text-gray-600">Taxes collect√©es:</span>
                      <span class="font-semibold text-gray-900" [innerHTML]="(salesReport().totalTax || 0) | gdesCurrency"></span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100">
                      <span class="text-gray-600">Profit net:</span>
                      <span class="font-semibold text-green-600" [innerHTML]="(salesReport().netProfit || 0) | gdesCurrency"></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          }
        }
      </div>
    </div>
  </main>
</div>

<!-- Multiple Delete Confirmation Modal -->
@if (showMultipleDeleteModal()) {
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
      <div class="p-6">
        <div class="flex items-center gap-4 mb-4">
          <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
            <ng-icon name="hugeAlert01" size="24" class="text-red-600"></ng-icon>
          </div>
          <div>
            <h3 class="text-lg font-bold text-gray-900">Supprimer les ventes</h3>
            <p class="text-sm text-gray-500">Cette action est irr√©versible</p>
          </div>
        </div>
        <p class="text-gray-700 mb-6">
          √ätes-vous s√ªr de vouloir supprimer <strong>{{ selectedSaleIds().size }} vente(s)</strong> s√©lectionn√©e(s) ?
          <br><span class="text-sm text-amber-600 mt-2 block">Note: Le stock sera automatiquement restaur√© pour les ventes compl√©t√©es.</span>
        </p>
        <div class="flex justify-end gap-3">
          <button
            (click)="closeMultipleDeleteModal()"
            [disabled]="loading()"
            class="px-6 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50 cursor-pointer">
            Annuler
          </button>
          <button
            (click)="confirmMultipleDelete()"
            [disabled]="loading()"
            class="px-6 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 flex items-center gap-2 cursor-pointer">
            @if (loading()) {
              <span class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></span>
            }
            Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>
}
