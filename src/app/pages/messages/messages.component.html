<div class="flex h-screen bg-white">
  <app-sidebar />

  <!-- Main Content -->
  <main class="relative flex-1 flex flex-col overflow-hidden bg-white">
    <app-pos-header />

    <!-- Titre de la page -->
    <div class="px-6 pt-4 pb-3 bg-white">
      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
        <div>
          <h1 class="text-xl font-bold text-gray-900 flex items-center gap-2">
            Demandes de Suppression
          </h1>
          <p class="text-sm text-gray-500 mt-1">Dashboard > Demandes de Suppression</p>
        </div>
      </div>
    </div>

    <!-- Contenu principal (scrollable) -->
    <div class="flex-1 overflow-y-auto px-6 pb-6 bg-white">
      <div class="bg-gray-100 rounded-[15px] p-4 border border-gray-300">

      <!-- Loading State -->
      @if (loading()) {
        <div class="flex items-center justify-center py-12">
          <div class="animate-spin rounded-full h-12 w-12 border-4 border-teal-500 border-t-transparent"></div>
        </div>
      }

      <!-- Tableau des demandes (Style Reports) -->
      @else {
        <div class="bg-white border border-gray-200 overflow-x-auto mb-15">
          <div class="p-4 border-b border-gray-200 bg-gray-50">
            <!-- Titre, filtres et dates sur la mÃªme ligne -->
            <div class="flex flex-wrap items-center gap-3 mb-4">
              <div>
                <h3 class="text-base font-semibold text-gray-900">Demandes de Suppression</h3>
                <p class="text-xs text-gray-500 mt-1">{{ filteredRequests().length }} demande(s) trouvÃ©e(s)</p>
              </div>

              <!-- SÃ©parateur vertical -->
              <div class="hidden lg:block h-10 w-px bg-gray-300"></div>

              <!-- Filtres rapides de statut -->
              <button
                (click)="filterByStatus('all')"
                [class]="'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ' + (selectedStatus() === 'all' ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')">
                Tous ({{ totalCount() }})
              </button>
              <button
                (click)="filterByStatus('pending')"
                [class]="'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ' + (selectedStatus() === 'pending' ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')">
                En attente ({{ pendingCount() }})
              </button>
              <button
                (click)="filterByStatus('approved')"
                [class]="'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ' + (selectedStatus() === 'approved' ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')">
                ApprouvÃ©es ({{ approvedCount() }})
              </button>
              <button
                (click)="filterByStatus('rejected')"
                [class]="'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ' + (selectedStatus() === 'rejected' ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')">
                RejetÃ©es ({{ rejectedCount() }})
              </button>

              <!-- SÃ©parateur vertical -->
              <div class="hidden lg:block h-10 w-px bg-gray-300"></div>

              <!-- Custom Date Range -->
              <div class="flex items-center gap-2">
                <!-- <span class="text-xs text-gray-500">De</span> -->
                <input
                  type="date"
                  [(ngModel)]="startDate"
                  (change)="onDateRangeChange()"
                  class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <span class="text-xs text-gray-500">Ã </span>
                <input
                  type="date"
                  [(ngModel)]="endDate"
                  [min]="startDate"
                  (change)="onDateRangeChange()"
                  class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
            </div>

            <!-- Filtre par vendeur et items per page -->
            <div class="flex flex-wrap items-center gap-3">
              <div class="flex items-center gap-3">
                <span class="text-sm font-medium text-gray-700">Recherche par Vendeur :</span>
                <select
                  [(ngModel)]="selectedSellerId"
                  (change)="onSellerFilterChange()"
                  class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                  <option value="all">Tous les vendeurs</option>
                  @for (seller of sellers(); track seller.id) {
                    <option [value]="seller.id">{{ seller.fullName || seller.username }}</option>
                  }
                </select>
              </div>

              <!-- Items per page selector -->
              <div class="ml-auto flex items-center gap-3">
                <select
                  [(ngModel)]="itemsPerPage"
                  (change)="onItemsPerPageChange()"
                  class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-teal-500 focus:border-transparent bg-white cursor-pointer">
                  <option value="10">ðŸ“„ 10 par page</option>
                  <option value="20">ðŸ“„ 20 par page</option>
                  <option value="30">ðŸ“„ 30 par page</option>
                  <option value="40">ðŸ“„ 40 par page</option>
                  <option value="50">ðŸ“„ 50 par page</option>
                </select>
              </div>
            </div>
          </div>

          @if (filteredRequests().length === 0) {
            <div class="p-8 text-center">
              <ng-icon name="hugeMessageDelay02" class="text-6xl text-gray-300 mb-4"></ng-icon>
              <p class="text-gray-500">Aucune demande trouvÃ©e pour ce filtre</p>
            </div>
          } @else {
          <table class="w-full">
            <thead class="bg-teal-600 text-white">
              <tr>
                <th class="w-12 px-3 md:px-4 py-3 text-left"></th>
                <th class="px-3 md:px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">#</th>
                <th class="px-3 md:px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Vendeur</th>
                <th class="px-3 md:px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Date</th>
                <th class="px-3 md:px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Motifs</th>
                <th class="px-3 md:px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Statut</th>
                <th class="px-3 md:px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Action</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              @for (request of paginatedRequests(); track request.id) {
                <!-- Ligne principale -->
                <tr [class]="'table-row-hover transition-colors ' + (request.status === 'pending' ? 'bg-yellow-50 hover:bg-yellow-100 border-l-4 border-l-yellow-300' : 'border-gray-50')">
                  <!-- IcÃ´ne dÃ©rouler -->
                  <td class="px-3 md:px-4 py-3">
                    <button
                      (click)="toggleRequestDetails(request.id)"
                      class="text-gray-400 hover:text-gray-600 transition-colors">
                      <ng-icon
                        [name]="expandedRequestId() === request.id ? 'hugeArrowDown02' : 'hugeArrowRightDouble'"
                        size="18">
                      </ng-icon>
                    </button>
                  </td>

                  <!-- # Vente -->
                  <td class="px-3 md:px-4 py-3">
                    <span class="text-sm text-gray-900">#{{ request.saleTicketNo }}</span>
                  </td>

                  <!-- Vendeur -->
                  <td class="px-3 md:px-4 py-3">
                    <span class="text-sm text-gray-900">{{ request.sellerName || 'N/A' }}</span>
                  </td>

                  <!-- Date -->
                  <td class="px-3 md:px-4 py-3">
                    <span class="text-sm text-gray-600">{{ formatDate(request.createdAt) }}</span>
                  </td>

                  <!-- Motifs (nombre) -->
                  <td class="px-3 md:px-4 py-3">
                    <span class="px-2.5 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full">
                      {{ request.reasons.length }} motif(s)
                    </span>
                  </td>

                  <!-- Statut -->
                  <td class="px-3 md:px-4 py-3">
                    <span
                      class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium"
                      [ngClass]="getStatusClass(request.status)">
                      {{ getStatusLabel(request.status) }}
                    </span>
                  </td>

                  <!-- Action -->
                  <td class="px-3 md:px-4 py-3">
                    @if (request.status === 'pending') {
                      <button
                        (click)="openResponseModal(request)"
                        class="px-3 py-1.5 bg-teal-600 text-white text-sm font-medium rounded-md hover:bg-teal-700 transition-colors">
                        RÃ©pondre
                      </button>
                    } @else {
                      <span class="text-gray-400">-</span>
                    }
                  </td>
                </tr>

                <!-- Ligne dÃ©tails (dÃ©roulable) -->
                @if (expandedRequestId() === request.id) {
                  <tr class="bg-gray-50">
                    <td colspan="7" class="px-4 py-4">
                      <div class="pl-12 space-y-3">
                        <!-- Motifs dÃ©taillÃ©s -->
                        <div>
                          <p class="text-sm font-medium text-gray-700 mb-2">Motifs de la demande:</p>
                          <div class="flex flex-wrap gap-2">
                            @for (reason of request.reasons; track reason) {
                              <span class="px-3 py-1 bg-white border border-gray-300 text-gray-700 text-sm rounded-full">
                                {{ getReasonLabel(reason) }}
                              </span>
                            }
                          </div>
                        </div>

                        <!-- Description -->
                        <div>
                          <p class="text-sm font-medium text-gray-700 mb-1">Description:</p>
                          <p class="text-sm text-gray-600 bg-white p-3 rounded-md border border-gray-200">
                            {{ request.description || 'Aucune description fournie' }}
                          </p>
                        </div>

                        <!-- RÃ©ponse de l'admin (si rejetÃ©e) -->
                        @if (request.status === 'rejected' && request.rejectionReason) {
                          <div class="bg-red-50 border border-red-200 rounded-md p-3">
                            <p class="text-sm font-medium text-red-800 mb-1">Raison du rejet:</p>
                            <p class="text-sm text-red-700">{{ request.rejectionReason }}</p>
                          </div>
                        }
                      </div>
                    </td>
                  </tr>
                }
              }
            </tbody>
          </table>

          <!-- Pagination Controls -->
          <div class="mt-0 flex flex-col sm:flex-row items-center justify-between gap-4 bg-gray-200 px-4 py-3">
            <!-- Info Section -->
            <div class="text-sm text-gray-900">
              Affichage des rÃ©sultats {{ paginationInfo().startIndex }} Ã  {{ paginationInfo().endIndex }} sur {{ paginationInfo().total }}
            </div>

            <!-- Navigation Buttons -->
            <div class="flex items-center gap-1">
              <!-- First Page Button -->
              <button
                (click)="firstPage()"
                [disabled]="paginationInfo().currentPage === 1"
                class="px-3 py-1.5 text-sm text-gray-900 hover:bg-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer transition-colors">
                Â«
              </button>

              <!-- Previous Button -->
              <button
                (click)="previousPage()"
                [disabled]="paginationInfo().currentPage === 1"
                class="px-3 py-1.5 text-sm text-gray-900 hover:bg-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer transition-colors">
                â€¹
              </button>

              <!-- Page Numbers -->
              @for (page of getPageNumbers(); track page) {
                <button
                  (click)="goToPage(page)"
                  [class]="page === paginationInfo().currentPage
                    ? 'px-3 py-1.5 text-sm bg-gray-700 text-white rounded cursor-pointer'
                    : 'px-3 py-1.5 text-sm text-gray-300 hover:bg-gray-700 rounded cursor-pointer transition-colors'">
                  {{ page }}
                </button>
              }

              <!-- Next Button -->
              <button
                (click)="nextPage()"
                [disabled]="paginationInfo().currentPage === paginationInfo().totalPages"
                class="px-3 py-1.5 text-sm text-gray-900 hover:bg-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer transition-colors">
                â€º
              </button>

              <!-- Last Page Button -->
              <button
                (click)="lastPage()"
                [disabled]="paginationInfo().currentPage === paginationInfo().totalPages"
                class="px-3 py-1.5 text-sm text-gray-900 hover:bg-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer transition-colors">
                Â»
              </button>
            </div>

            <!-- Summary Info -->
            <div class="text-sm text-gray-900 flex items-center gap-1">
              <span>Total demandes : </span>
              <strong class="text-teal-600 text-base">{{ paginationInfo().total }}</strong>
            </div>
          </div>
          }
        </div>
      }

      </div> <!-- Fermeture grey-container -->
    </div> <!-- Fermeture contenu scrollable -->
  </main>
</div>

<!-- Modale de rÃ©ponse -->
@if (showModal()) {
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <!-- Header de la modale -->
      <div class="bg-gradient-to-r from-teal-600 to-teal-700 px-6 py-4 rounded-t-xl">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold text-white flex items-center gap-2">
            <ng-icon name="hugeMessageDelay02" size="24"></ng-icon>
            RÃ©pondre Ã  la demande
          </h3>
          <button
            (click)="closeModal()"
            [disabled]="submitting()"
            class="text-white hover:text-gray-200 transition-colors">
            <ng-icon name="hugeCancel01" size="24"></ng-icon>
          </button>
        </div>
      </div>

      <!-- Contenu de la modale -->
      <div class="p-6 space-y-4">
        <!-- Informations de la demande -->
        <div class="bg-gray-50 rounded-lg p-4 space-y-3">
          <h4 class="font-semibold text-gray-900 text-lg mb-3">Informations de la demande</h4>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <!-- NumÃ©ro de vente -->
            <div>
              <p class="text-xs text-gray-500 mb-1">NumÃ©ro de vente</p>
              <p class="text-sm font-semibold text-gray-900">#{{ selectedRequest()?.saleTicketNo }}</p>
            </div>

            <!-- Vendeur -->
            <div>
              <p class="text-xs text-gray-500 mb-1">Vendeur</p>
              <p class="text-sm font-semibold text-gray-900">{{ selectedRequest()?.sellerName || 'N/A' }}</p>
            </div>

            <!-- Date de demande -->
            <div>
              <p class="text-xs text-gray-500 mb-1">Date de la demande</p>
              <p class="text-sm font-semibold text-gray-900">{{ formatDate(selectedRequest()?.createdAt || '') }}</p>
            </div>

            <!-- Statut -->
            <div>
              <p class="text-xs text-gray-500 mb-1">Statut actuel</p>
              <span
                class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium"
                [ngClass]="getStatusClass(selectedRequest()?.status || '')">
                {{ getStatusLabel(selectedRequest()?.status || '') }}
              </span>
            </div>
          </div>

          <!-- Motifs -->
          <div>
            <p class="text-xs text-gray-500 mb-2">Motifs de la demande</p>
            <div class="flex flex-wrap gap-2">
              @for (reason of selectedRequest()?.reasons || []; track reason) {
                <span class="px-3 py-1 bg-white border border-gray-300 text-gray-700 text-sm rounded-full">
                  {{ getReasonLabel(reason) }}
                </span>
              }
            </div>
          </div>

          <!-- Description de la demande -->
          <div>
            <p class="text-xs text-gray-500 mb-1">Description du vendeur</p>
            <p class="text-sm text-gray-700 bg-white p-3 rounded-md border border-gray-200">
              {{ selectedRequest()?.description || 'Aucune description fournie' }}
            </p>
          </div>
        </div>

        <!-- Zone de rÃ©ponse (optionnelle pour rejet) -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Votre rÃ©ponse (optionnel - uniquement pour rejet)
            <span class="text-gray-400 text-xs ml-1">(facultatif)</span>
          </label>
          <textarea
            [(ngModel)]="responseDescription"
            rows="4"
            [disabled]="submitting()"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-colors"
            placeholder="Expliquez pourquoi vous rejetez cette demande (optionnel)..."></textarea>
          <p class="text-xs text-gray-500 mt-1">
            Cette description sera visible par le vendeur en cas de rejet
          </p>
        </div>
      </div>

      <!-- Footer avec actions -->
      <div class="bg-gray-50 px-6 py-4 rounded-b-xl border-t border-gray-200">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <!-- Bouton Fermer -->
          <button
            (click)="closeModal()"
            [disabled]="submitting()"
            class="px-5 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            Fermer
          </button>

          <!-- Actions principales -->
          <div class="flex items-center gap-3">
            <!-- Rejeter -->
            <button
              (click)="handleReject()"
              [disabled]="submitting() || selectedRequest()?.status !== 'pending'"
              class="px-5 py-2.5 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
              <ng-icon name="hugeCancel02" size="18"></ng-icon>
              <span>{{ submitting() && modalAction() === 'reject' ? 'Traitement...' : 'Rejeter' }}</span>
            </button>

            <!-- Approuver & Supprimer (Supprime la vente et archive la demande) -->
            <button
              (click)="handleApprove()"
              [disabled]="submitting() || selectedRequest()?.status !== 'pending'"
              class="px-5 py-2.5 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 shadow-md">
              <ng-icon name="hugeCheckmarkCircle02" size="18"></ng-icon>
              <span>{{ submitting() && modalAction() === 'approve' ? 'Traitement...' : 'Approuver & Supprimer' }}</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
}
